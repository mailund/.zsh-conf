print()  { echo "$@" >&2 }
yield()  { echo "$@"     }

activate_dirs() {
    local dir
    for dir in $(find . -mindepth 1 -maxdepth 1 -type d); do
        if [ -f "$dir/bin/activate" ]; then
            yield $dir
        fi
    done
}

select_venv() {
    local candidates=("$@")

    if [ ${#candidates[@]} -eq 0 ]; then
        print "No virtual environments found." 
        return 1
    elif [ ${#candidates[@]} -eq 1 ]; then
        yield "${candidates[1]}"
    else
        print "Multiple virtual environments found." 
        print "Please select one:" 
        select venv_dir in "${candidates[@]}"; do
            [ -n "$venv_dir" ] && echo "$venv_dir" && return
        done
    fi
}

activate_venv() {
    local venv_dir="$1"
    local venv_activate="$venv_dir/bin/activate"

    if [ -f "$venv_activate" ]; then
        source "$venv_activate" && \
            echo "Activated virtual environment: $venv_dir" || \
            echo "Failed to activate virtual environment: $venv_dir" >&2
    else
        echo "Error: Virtual environment activation script not found in $venv_dir" >&2
        return 1
    fi
}

venv_dir=$(select_venv $(activate_dirs)) || exit 1
activate_venv "$venv_dir"

fixit_start() {
    local branch=$1

    export PUSHED_GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

    # Save state
    git stash $branch

    # Create new branch from main
    git checkout main
    git pull
    git checkout -b $branch
}

fixit_done() {
    # Turn changes into a pull request
    if [[ "$1" == "" ]]; then
        echo "Please provide a title for the pull request"
        return
    fi
    git add .
    git commit -am "$@"
    git push --set-upstream origin $PUSHED_GIT_BRANCH
    echo Opening pull request...
    gh pr create --web --title $1 --body $1

    # Restore pushed state
    git checkout $PUSHED_GIT_BRANCH
    git stash pop $PUSHED_GIT_BRANCH    
}

if [[ "$1" == "done" ]]; then
    shift
    fixit_done $@
else
    fixit_start $@
fi
